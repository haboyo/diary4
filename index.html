<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Bong's Diary">
    <meta name="theme-color" content="#FDFCF8">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJvbmcncyBEaWFyeSIsCiAgInNob3J0X25hbWUiOiAiQm9uZyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRkRGQ0Y4IiwKICAidGhlbWVfY29sb3IiOiAiI0ZERkNGOCIKfQ==">
    
    <link rel="apple-touch-icon" href="https://github.com/haboyo/diary3/blob/main/diary.jpg?raw=true&v=final">
    <link rel="icon" type="image/jpeg" href="https://github.com/haboyo/diary3/blob/main/diary.jpg?raw=true&v=final">

    <title>Bong's Diary v3.7.17</title>
    
    <!-- iOS 오프라인 안정성을 위해 CDN 순서 및 속성 최적화 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Inter:wght@300;400;600;800&family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        
        :root {
            --bg-main: #FDFCF8;
            --text-main: #1A1A1A;
            --soft-gray: #F1F0EB;
            --weekend-sun: #E15B5B;
            --weekend-sat: #5B82E1;
            --share-yellow: #FEE500;
        }

        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: var(--bg-main);
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }

        header { flex-shrink: 0; background: var(--bg-main); z-index: 10; }
        main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 20px; scroll-behavior: smooth; }
        
        nav { 
            flex-shrink: 0; 
            padding-bottom: calc(env(safe-area-inset-bottom) + 12px); 
            padding-top: 12px;
            background: rgba(253, 252, 248, 0.95); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid #F1F0EB; 
        }

        .cursive-title { font-family: 'Dancing Script', cursive; font-size: 1.7rem; color: var(--text-main); opacity: 0.9; }
        .btn-press:active { transform: scale(0.96); transition: transform 0.1s; }
        textarea:focus, input:focus { outline: none; }
        
        .journal-textarea { 
            font-size: 15px !important; 
            line-height: 1.4 !important; 
            width: 100%; 
            height: 100%; 
            min-height: 250px; 
        }

        .line-clamp-2-custom {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memo-card-highlighted, .todo-card-highlighted {
            border-color: #3b82f6 !important;
            border-width: 2px !important;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
            transform: scale(1.02);
            z-index: 10;
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .calendar-dot { width: 4px; height: 4px; background-color: var(--text-main); border-radius: 50%; margin-top: 2px; opacity: 0.3; }
        .text-sun { color: var(--weekend-sun) !important; }
        .text-sat { color: var(--weekend-sat) !important; }

        .calendar-month-title { font-size: 2.5rem; font-weight: 900; letter-spacing: -0.05em; }

        .btn-share { background-color: var(--share-yellow); color: #3C1E1E; font-weight: 800; font-size: 11px; padding: 6px 14px; border-radius: 8px; display: flex; align-items: center; gap: 6px; }
        .btn-copy { background-color: #F1F0EB; color: #1A1A1A; padding: 6px 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        .tag-chip {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            background: white;
            border: 1px solid #E5E7EB;
            white-space: nowrap;
            cursor: pointer;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .i-icon {
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root" style="width: 100%; height: 100%;"></div>

    <!-- Service Worker for Persistent Offline Access -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swContent = `
                    const CACHE_NAME = 'bongs-diary-v3.7.17-cache';
                    const ASSETS = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/lucide@latest',
                        'https://unpkg.com/react@18/umd/react.production.min.js',
                        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
                        'https://unpkg.com/@babel/standalone/babel.min.js',
                        'https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Inter:wght@300;400;600;800&family=Noto+Sans+KR:wght@300;400;700;900&display=swap'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => {
                                return cache.addAll(ASSETS);
                            })
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((keys) => {
                                return Promise.all(
                                    keys.filter((key) => key !== CACHE_NAME).map((key) => caches.delete(key))
                                );
                            })
                        );
                        self.clients.claim();
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((cachedResponse) => {
                                if (cachedResponse) return cachedResponse;
                                return fetch(event.request).catch(() => {
                                    if (event.request.mode === 'navigate') {
                                        return caches.match('/');
                                    }
                                });
                            })
                        );
                    });
                `;
                const blob = new Blob([swContent], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('Service Worker Registered');
                });
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const KOREAN_HOLIDAYS = {
            "2024": {"01-01":"신정","02-09":"설날연휴","02-10":"설날","02-11":"설날연휴","02-12":"대체공휴일","03-01":"삼일절","04-10":"선거일","05-05":"어린이날","05-06":"대체공휴일","05-15":"석가탄신일","06-06":"현충일","08-15":"광복절","09-16":"추석연휴","09-17":"추석","09-18":"추석연휴","10-03":"개천절","10-09":"한글날","12-25":"성탄절"},
            "2025": {"01-01":"신정","01-27":"설날연휴","01-28":"설날","01-29":"설날연휴","01-30":"대체공휴일","03-01":"삼일절","03-03":"대체공휴일","05-05":"어린이날","05-06":"대체공휴일","06-06":"현충일","08-15":"광복절","10-03":"개천절","10-05":"추석연휴","10-06":"추석","10-07":"추석연휴","10-08":"대체공휴일","10-09":"한글날","12-25":"성탄절"},
            "2026": {"01-01":"신정","02-16":"설날연휴","02-17":"설날","02-18":"설날연휴","03-01":"삼일절","03-02":"대체공휴일","05-05":"어린이날","05-24":"석가탄신일","05-25":"대체공휴일","06-06":"현충일","08-15":"광복절","08-17":"대체공휴일","09-24":"추석연휴","09-25":"추석","09-26":"추석연휴","10-03":"개천절","10-05":"대체공휴일","10-09":"한글날","12-25":"성탄절"}
        };

        const STORAGE_KEY = 'bong_diary_pro_v3';
        const APP_VERSION = 'v3.7.17';
        const APP_NAME = "Bong's Diary";

        const toLocalDateString = (date) => {
            if (!date) return "";
            const d = typeof date === 'string' ? new Date(date) : date;
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        const Icon = ({ name, className = "w-4 h-4" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.className = className;
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({ attrs: { strokeWidth: 2 } });
                }
            }, [name, className]);
            return <span ref={iconRef} className="i-icon" />;
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('Journal');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [viewMonth, setViewMonth] = useState(new Date());
            const [showCalendar, setShowCalendar] = useState(false);
            const [calendarMode, setCalendarMode] = useState('select');
            const [message, setMessage] = useState('');
            const [deleteConfirm, setDeleteConfirm] = useState({ show: false, type: null, id: null });
            const [expandedMemoIds, setExpandedMemoIds] = useState(new Set());
            const [highlightedMemoId, setHighlightedMemoId] = useState(null);
            const [highlightedTodoId, setHighlightedTodoId] = useState(null);
            const [weekAnchor, setWeekAnchor] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - d.getDay());
                return d;
            });
            const fileInputRef = useRef(null);
            const memoTextareaRef = useRef(null);
            const mainScrollRef = useRef(null);
            
            const [journals, setJournals] = useState(() => JSON.parse(localStorage.getItem(`${STORAGE_KEY}_journals`) || '{}'));
            const [memos, setMemos] = useState(() => JSON.parse(localStorage.getItem(`${STORAGE_KEY}_memos`) || '[]'));
            const [todos, setTodos] = useState(() => JSON.parse(localStorage.getItem(`${STORAGE_KEY}_todos`) || '[]'));
            const [newTodo, setNewTodo] = useState({ text: '', date: '' });
            const [newMemo, setNewMemo] = useState({ content: '', tag: '', id: null });
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                localStorage.setItem(`${STORAGE_KEY}_journals`, JSON.stringify(journals));
                localStorage.setItem(`${STORAGE_KEY}_memos`, JSON.stringify(memos));
                localStorage.setItem(`${STORAGE_KEY}_todos`, JSON.stringify(todos));
            }, [journals, memos, todos]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [activeTab, showCalendar]);

            useEffect(() => {
                if (memoTextareaRef.current && activeTab === 'Memo') {
                    memoTextareaRef.current.style.height = 'auto';
                    memoTextareaRef.current.style.height = `${Math.max(60, memoTextareaRef.current.scrollHeight)}px`;
                }
            }, [newMemo.content, activeTab]);

            useEffect(() => {
                const d = new Date(currentDate);
                d.setDate(d.getDate() - d.getDay());
                setWeekAnchor(d);
            }, [currentDate]);

            useEffect(() => {
                if (highlightedMemoId || highlightedTodoId) {
                    const timer = setTimeout(() => {
                        setHighlightedMemoId(null);
                        setHighlightedTodoId(null);
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [highlightedMemoId, highlightedTodoId]);

            const currentDayTodos = useMemo(() => {
                const dateKey = toLocalDateString(currentDate);
                return todos.filter(t => t.date === dateKey);
            }, [todos, currentDate]);

            const organizedTodos = useMemo(() => {
                const noDate = todos.filter(t => !t.date || t.date === "");
                const withDate = todos.filter(t => t.date && t.date !== "");
                const groups = withDate.reduce((acc, todo) => {
                    if (!acc[todo.date]) acc[todo.date] = [];
                    acc[todo.date].push(todo);
                    return acc;
                }, {});
                const sortedDates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
                return { noDate, groups, sortedDates };
            }, [todos]);

            const existingTags = useMemo(() => {
                const tags = memos.map(m => m.tag).filter(t => t && t.trim() !== '');
                return [...new Set(tags)].sort();
            }, [memos]);

            const groupedMemos = useMemo(() => {
                const groups = {};
                const noTag = [];
                memos.forEach(memo => {
                    if (memo.tag && memo.tag.trim() !== '') {
                        if (!groups[memo.tag]) groups[memo.tag] = [];
                        groups[memo.tag].push(memo);
                    } else { noTag.push(memo); }
                });
                return { groups, noTag };
            }, [memos]);

            const showToast = (msg) => {
                setMessage(msg);
                setTimeout(() => setMessage(''), 2000);
            };

            const getHolidayName = (date) => {
                if (!date) return null;
                const dObj = typeof date === 'string' ? new Date(date) : date;
                const y = dObj.getFullYear().toString();
                const m = String(dObj.getMonth() + 1).padStart(2, '0');
                const d = String(dObj.getDate()).padStart(2, '0');
                return KOREAN_HOLIDAYS[y]?.[`${m}-${d}`] || null;
            };

            const moveWeek = (offset) => {
                const newCurrent = new Date(currentDate);
                newCurrent.setDate(currentDate.getDate() + (offset * 7));
                setCurrentDate(newCurrent);
            };

            const filteredResults = () => {
                if (!searchQuery.trim()) return [];
                const res = [];
                Object.entries(journals).forEach(([dateStr, content]) => {
                    if (content.includes(searchQuery)) res.push({ type: 'Journal', date: dateStr, text: content });
                });
                memos.forEach(m => {
                    if (m.content.includes(searchQuery) || (m.tag && m.tag.includes(searchQuery))) {
                        res.push({ type: 'Memo', id: m.id, date: m.date, text: m.content, tag: m.tag });
                    }
                });
                todos.forEach(t => {
                    if (t.text.includes(searchQuery)) {
                        res.push({ type: 'Todo', id: t.id, text: t.text, date: t.date || "기한 없음" });
                    }
                });
                return res;
            };

            const getFormattedShareText = () => {
                const rawContent = journals[currentDate.toDateString()];
                if (!rawContent) return null;
                const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dd = String(currentDate.getDate()).padStart(2, '0');
                return `${mm}/${dd}\n\n${rawContent}`;
            };

            const handleShare = () => {
                const shareText = getFormattedShareText();
                if (!shareText) return showToast('공유할 내용이 없습니다');
                if (navigator.share) {
                    navigator.share({ title: APP_NAME, text: shareText }).catch(() => {});
                } else { copyToClipboard(shareText); }
            };

            const copyToClipboard = (text) => {
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try { document.execCommand("copy"); showToast('복사됨'); } catch (err) { showToast('복사 실패'); }
                document.body.removeChild(tempInput);
            };

            const handleExport = () => {
                const data = { journals, memos, todos, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bongs_diary_backup.json`;
                a.click();
                showToast('백업 완료');
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.journals) setJournals(data.journals);
                        if (data.memos) setMemos(data.memos);
                        if (data.todos) setTodos(data.todos);
                        showToast('데이터 복원 성공');
                    } catch (err) { showToast('파일 형식 오류'); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const saveMemo = () => {
                if(!newMemo.content.trim()) return;
                if (newMemo.id) {
                    setMemos(memos.map(m => m.id === newMemo.id ? { ...m, content: newMemo.content, tag: newMemo.tag } : m));
                    showToast('메모 수정됨');
                } else {
                    setMemos([{id:Date.now(), content:newMemo.content, tag:newMemo.tag, date:new Date().toLocaleDateString()}, ...memos]);
                    showToast('메모 추가됨');
                }
                setNewMemo({content:'', tag:'', id: null});
            };

            const startEditMemo = (e, memo) => {
                e.stopPropagation();
                setNewMemo({ content: memo.content, tag: memo.tag || '', id: memo.id });
                if (mainScrollRef.current) mainScrollRef.current.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleMemoSelect = (memoId) => {
                setHighlightedMemoId(prevId => prevId === memoId ? null : memoId);
                setExpandedMemoIds(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(memoId)) newSet.delete(memoId); else newSet.add(memoId);
                    return newSet;
                });
            };

            const executeDelete = () => {
                const { type, id } = deleteConfirm;
                if (type === 'memo') setMemos(memos.filter(item => item.id !== id));
                else if (type === 'todo') setTodos(todos.filter(item => item.id !== id));
                setDeleteConfirm({ show: false, type: null, id: null });
                showToast('삭제되었습니다');
            };

            const toggleTodo = (id) => {
                setTodos(prev => prev.map(t => t.id === id ? { ...t, done: !t.done } : t));
            };

            const addTodo = () => {
                if(!newTodo.text.trim()) return;
                const newTodoItem = {
                    id: Date.now(),
                    text: newTodo.text,
                    date: newTodo.date,
                    done: false
                };
                setTodos(prev => [newTodoItem, ...prev]);
                setNewTodo({ text: '', date: '' });
                showToast('할 일이 추가되었습니다');
            };

            const TodoItem = ({ t }) => {
                const holiday = t.date ? getHolidayName(t.date) : null;
                const isSun = t.date && new Date(t.date).getDay() === 0;
                const isSat = t.date && new Date(t.date).getDay() === 6;
                const isHighlighted = highlightedTodoId === t.id;

                return (
                    <div className={`flex items-center gap-3 bg-white p-4 rounded-2xl border transition-all duration-300 group ${isHighlighted ? 'todo-card-highlighted' : 'border-black/5 shadow-sm'}`}>
                        <button 
                            onClick={() => toggleTodo(t.id)} 
                            className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all btn-press ${t.done ? 'bg-green-500 border-green-500' : 'border-slate-200'}`}
                        >
                            {t.done && <Icon name="check" className="w-4 h-4 text-white" />}
                        </button>
                        <div className="flex-1 flex flex-col cursor-pointer" onClick={() => toggleTodo(t.id)}>
                            <span className={`text-[14px] font-semibold leading-tight transition-all duration-300 ${t.done ? 'opacity-20 line-through' : 'text-slate-700'}`}>{t.text}</span>
                            {t.date && (
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`text-[9px] font-black uppercase flex items-center gap-1 ${t.done ? 'opacity-10' : (holiday || isSun) ? 'text-sun' : isSat ? 'text-sat' : 'opacity-30'}`}>
                                        <Icon name="calendar" className="w-2.5 h-2.5" />{t.date}
                                    </span>
                                    {holiday && (
                                        <span className={`text-[8px] font-bold px-1.5 py-0.5 rounded bg-red-50 text-red-400 border border-red-100 ${t.done ? 'opacity-20' : ''}`}>
                                            {holiday}
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>
                        <button onClick={() => setDeleteConfirm({ show: true, type: 'todo', id: t.id })} className="opacity-0 group-hover:opacity-20 transition-opacity p-1 btn-press"><Icon name="trash-2" className="w-4 h-4" /></button>
                    </div>
                );
            };

            const MemoCard = ({ m }) => (
                <div 
                    onClick={() => handleMemoSelect(m.id)}
                    className={`bg-white p-5 rounded-2xl border transition-all duration-300 cursor-pointer ${highlightedMemoId === m.id ? 'memo-card-highlighted' : 'border-black/5'}`}
                >
                    <p className={`text-[14px] opacity-80 whitespace-pre-wrap transition-all ${!expandedMemoIds.has(m.id) ? 'line-clamp-2-custom' : ''}`} style={{ lineHeight: '1.4' }}>
                        {m.content}
                    </p>
                    <div className="flex justify-between items-center mt-4 pt-2 border-t border-slate-50">
                        <div className="flex items-center gap-3">
                            <span className="text-[8px] font-black opacity-20">{m.date}</span>
                            <button onClick={(e) => { e.stopPropagation(); copyToClipboard(m.content); }} className="text-[#1A1A1A] opacity-20 btn-press"><Icon name="copy" className="w-3.5 h-3.5" /></button>
                            <button onClick={(e) => startEditMemo(e, m)} className="text-[#1A1A1A] opacity-20 btn-press"><Icon name="edit-3" className="w-3.5 h-3.5" /></button>
                        </div>
                        <button onClick={(e)=>{ e.stopPropagation(); setDeleteConfirm({ show: true, type: 'memo', id: m.id }); }} className="text-red-400 opacity-20"><Icon name="trash-2" className="w-3.5 h-3.5" /></button>
                    </div>
                </div>
            );

            return (
                <div className="app-container">
                    {message && <div className="fixed top-12 left-1/2 -translate-x-1/2 z-[2000] bg-[#1A1A1A] text-white px-5 py-2 rounded-full text-[11px] font-bold shadow-2xl fade-in text-center">{message}</div>}

                    {deleteConfirm.show && (
                        <div className="fixed inset-0 z-[3000] flex items-center justify-center px-6 modal-overlay">
                            <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
                                <div className="text-center">
                                    <div className="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="alert-triangle" className="w-6 h-6 text-red-500" /></div>
                                    <h3 className="text-lg font-black tracking-tight text-slate-900 mb-2">정말 삭제할까요?</h3>
                                    <p className="text-sm text-slate-500 font-medium leading-relaxed mb-6">삭제된 기록은 되돌릴 수 없습니다.</p>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirm({ show: false, type: null, id: null })} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl text-[13px] font-black uppercase btn-press">취소</button>
                                    <button onClick={executeDelete} className="flex-1 py-3 bg-red-500 text-white rounded-xl text-[13px] font-black uppercase shadow-lg btn-press">삭제하기</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="px-5 pt-5 pb-2">
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex-1">
                                <div className="cursive-title mb-2">{APP_NAME}</div>
                                <div className="flex items-center gap-2 mt-4 h-10">
                                    <button onClick={() => { setViewMonth(new Date(currentDate)); setCalendarMode('select'); setShowCalendar(true); }} className="text-2xl font-black tracking-tighter flex items-center gap-1.5 btn-press">
                                        {currentDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })}
                                        <Icon name="calendar" className="w-5 h-5 opacity-20" />
                                    </button>
                                    {getHolidayName(currentDate) && <div className="px-2 py-0.5 bg-red-50 text-[10px] font-bold text-sun rounded border border-red-100">{getHolidayName(currentDate)}</div>}
                                </div>
                            </div>
                            <button onClick={() => setCurrentDate(new Date())} className="mt-2 text-[10px] font-black tracking-widest opacity-40 uppercase border-b border-black/10 btn-press">Today</button>
                        </div>
                        {activeTab === 'Journal' && (
                            <div className="flex items-center gap-2 px-0.5 pb-2">
                                <button onClick={() => moveWeek(-1)} className="p-1.5 opacity-20 btn-press"><Icon name="chevron-left" className="w-4 h-4" /></button>
                                <div className="flex flex-1 justify-between overflow-x-hidden">
                                    {Array.from({ length: 7 }, (_, i) => {
                                        const d = new Date(weekAnchor);
                                        d.setDate(weekAnchor.getDate() + i);
                                        const isSelected = d.toDateString() === currentDate.toDateString();
                                        const hDay = getHolidayName(d);
                                        const isSun = d.getDay() === 0 || hDay;
                                        return (
                                            <button key={i} onClick={() => setCurrentDate(d)} className="flex flex-col items-center flex-1">
                                                <span className={`text-[10px] font-black mb-2.5 ${isSelected ? 'opacity-100' : 'opacity-25'} ${isSun?'text-sun':d.getDay()===6?'text-sat':''}`}>{['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()]}</span>
                                                <span className={`text-[13px] w-8 h-8 flex items-center justify-center rounded-full transition-all ${isSelected ? 'bg-[#1A1A1A] text-white font-bold' : isSun ? 'text-sun opacity-60' : 'text-slate-400'}`}>{d.getDate()}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                                <button onClick={() => moveWeek(1)} className="p-1.5 opacity-20 btn-press"><Icon name="chevron-right" className="w-4 h-4" /></button>
                            </div>
                        )}
                    </header>

                    <main ref={mainScrollRef} className="no-scrollbar px-5">
                        {activeTab === 'Journal' && (
                            <div className="h-full flex flex-col fade-in pt-1">
                                {currentDayTodos.length > 0 && (
                                    <div className="mb-4 space-y-2">
                                        <div className="flex items-center gap-2">
                                            <span className="text-[10px] font-black uppercase opacity-20 tracking-widest">Tasks for today</span>
                                            <div className="h-[1px] flex-1 bg-black/5"></div>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {currentDayTodos.map(todo => (
                                                <button key={todo.id} onClick={() => { setHighlightedTodoId(todo.id); setActiveTab('Todo'); }} className={`px-3 py-1.5 rounded-full text-[11px] font-bold border flex items-center gap-2 transition-all btn-press ${todo.done ? 'bg-slate-50 border-slate-100 text-slate-300' : 'bg-white border-black/10 text-slate-600 shadow-sm'}`}>
                                                    {todo.done ? <Icon name="check-circle-2" className="w-3 h-3" /> : <div className="w-2 h-2 rounded-full bg-blue-400"></div>}
                                                    {todo.text}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-[10px] font-black tracking-widest uppercase opacity-30">Record</span>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => { const t = getFormattedShareText(); if(t) copyToClipboard(t); }} className="btn-copy btn-press"><Icon name="copy" className="w-4 h-4" /></button>
                                        <button onClick={handleShare} className="btn-share btn-press"><Icon name="message-circle" className="w-3.5 h-3.5" />Share</button>
                                    </div>
                                </div>
                                <textarea className="flex-1 bg-transparent border-none resize-none journal-textarea placeholder:opacity-10" placeholder="오늘은 어떤일이 있었나요?" value={journals[currentDate.toDateString()] || ''} onChange={(e) => setJournals({...journals, [currentDate.toDateString()]: e.target.value})} />
                            </div>
                        )}

                        {activeTab === 'Todo' && (
                            <div className="fade-in space-y-3 pt-3 pb-8">
                                <div className="bg-[#F1F0EB] rounded-2xl p-4 space-y-3">
                                    <div className="flex items-center gap-2">
                                        <input className="flex-1 bg-white rounded-xl px-4 py-3 text-[14px] font-medium shadow-sm" placeholder="할 일을 입력하세요" value={newTodo.text} onChange={e => setNewTodo({...newTodo, text: e.target.value})} onKeyDown={e => e.key === 'Enter' && addTodo()} />
                                        <button onClick={addTodo} className="bg-[#1A1A1A] text-white p-3.5 rounded-xl shadow-lg btn-press"><Icon name="plus" className="w-4 h-4" /></button>
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <button 
                                            onClick={() => {
                                                const d = newTodo.date ? new Date(newTodo.date) : new Date();
                                                setViewMonth(d);
                                                setCalendarMode('todo');
                                                setShowCalendar(true);
                                            }}
                                            className="flex items-center justify-between bg-white rounded-xl px-4 py-3 shadow-sm w-full btn-press"
                                        >
                                            <div className="flex items-center">
                                                <Icon name="calendar" className="w-3.5 h-3.5 opacity-20 mr-2" />
                                                <span className="text-[13px] font-bold text-slate-600">
                                                    {newTodo.date ? newTodo.date : '날짜 선택 (선택사항)'}
                                                </span>
                                            </div>
                                            {newTodo.date && <button onClick={(e) => { e.stopPropagation(); setNewTodo({...newTodo, date: ''}); }} className="opacity-20"><Icon name="x" className="w-3 h-3" /></button>}
                                        </button>
                                    </div>
                                </div>

                                <div className="pt-4 space-y-8">
                                    <div className="space-y-3 pt-2">
                                        <div className="flex items-center gap-2 px-1">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">해야 할 일 (기간 없음)</span>
                                            <div className="h-[1px] flex-1 bg-slate-100" />
                                        </div>
                                        {organizedTodos.noDate.length > 0 ? (
                                            organizedTodos.noDate.map(t => <TodoItem key={t.id} t={t} />)
                                        ) : (
                                            <p className="text-center py-8 text-[11px] font-bold text-slate-300 uppercase tracking-widest">No pending tasks</p>
                                        )}
                                    </div>

                                    {organizedTodos.sortedDates.map(date => {
                                        const hName = getHolidayName(date);
                                        const dObj = new Date(date);
                                        const isSun = dObj.getDay() === 0;
                                        const isSat = dObj.getDay() === 6;
                                        return (
                                            <div key={date} className="space-y-3">
                                                <div className="flex items-center gap-2 px-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-[10px] font-black uppercase tracking-widest ${(hName || isSun) ? 'text-sun' : isSat ? 'text-sat' : 'text-blue-500'}`}>{date}</span>
                                                        {hName && <span className="text-[9px] font-bold text-red-400 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">{hName}</span>}
                                                    </div>
                                                    <div className={`h-[1px] flex-1 ${(hName || isSun) ? 'bg-red-100' : isSat ? 'bg-blue-100' : 'bg-blue-100'}`} />
                                                </div>
                                                {organizedTodos.groups[date].map(t => <TodoItem key={t.id} t={t} />)}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'Memo' && (
                            <div className="fade-in space-y-6 pt-3 pb-8">
                                <div className={`p-3 rounded-2xl space-y-3 transition-colors ${newMemo.id ? 'bg-blue-50 border border-blue-100' : 'bg-[#F1F0EB]'}`}>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-[10px] font-black uppercase opacity-40">{newMemo.id ? 'Edit Mode' : 'New Memo'}</span>
                                        {newMemo.id && <button onClick={() => setNewMemo({content:'', tag:'', id: null})} className="text-[9px] font-bold text-blue-500 underline uppercase">Cancel</button>}
                                    </div>
                                    <div className="space-y-2">
                                        <input className="w-full bg-white px-3 py-2 rounded-lg text-xs font-bold" placeholder="#태그 (선택)" value={newMemo.tag} onChange={e=>setNewMemo({...newMemo, tag: e.target.value})} />
                                        {existingTags.length > 0 && (
                                            <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                                {existingTags.map(tag => (
                                                    <button key={tag} onClick={() => setNewMemo({...newMemo, tag})} className="tag-chip btn-press">#{tag}</button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <textarea ref={memoTextareaRef} className="w-full bg-transparent p-1 text-[13px] min-h-[60px] resize-none border-none" placeholder="여기에 메모하세요..." value={newMemo.content} onChange={e=>setNewMemo({...newMemo, content: e.target.value})} />
                                    <button onClick={saveMemo} className={`w-full text-white py-2.5 rounded-lg text-[10px] font-black uppercase tracking-widest ${newMemo.id ? 'bg-blue-600 shadow-lg' : 'bg-[#1A1A1A]'}`}>{newMemo.id ? 'Update Memo' : 'Add Memo'}</button>
                                </div>
                                <div className="space-y-8">
                                    {Object.entries(groupedMemos.groups).map(([tagName, items]) => (
                                        <div key={tagName} className="space-y-3">
                                            <div className="flex items-center gap-2 px-1"><span className="text-[10px] font-black text-blue-500 uppercase tracking-widest">#{tagName}</span><div className="h-[1px] flex-1 bg-blue-100" /></div>
                                            {items.map(m => <MemoCard key={m.id} m={m} />)}
                                        </div>
                                    ))}
                                    {groupedMemos.noTag.length > 0 && (
                                        <div className="space-y-3">
                                            {Object.keys(groupedMemos.groups).length > 0 && <div className="flex items-center gap-2 px-1"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Others</span><div className="h-[1px] flex-1 bg-slate-100" /></div>}
                                            {groupedMemos.noTag.map(m => <MemoCard key={m.id} m={m} />)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'Search' && (
                            <div className="fade-in pt-3 pb-8">
                                <div className="relative mb-6">
                                    <input className="w-full bg-[#F1F0EB] rounded-2xl pl-12 pr-5 py-4 text-[15px] font-bold" placeholder="검색어를 입력하세요" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                    <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 opacity-20" />
                                </div>
                                <div className="space-y-4">
                                    {filteredResults().map((item, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-2xl border border-black/5 btn-press" onClick={() => {
                                            if(item.type === 'Journal') { setCurrentDate(new Date(item.date)); setActiveTab('Journal'); }
                                            else if (item.type === 'Memo') { 
                                                setHighlightedMemoId(item.id); 
                                                setExpandedMemoIds(prev => new Set(prev).add(item.id)); 
                                                setActiveTab('Memo'); 
                                            }
                                            else {
                                                setHighlightedTodoId(item.id);
                                                setActiveTab('Todo');
                                            }
                                        }}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className={`text-[9px] font-black uppercase px-2 py-0.5 rounded ${item.type === 'Journal' ? 'bg-blue-50 text-blue-500' : item.type === 'Memo' ? 'bg-orange-50 text-orange-500' : 'bg-green-50 text-green-500'}`}>{item.type}</span>
                                                {item.date && (
                                                    <span className="text-[9px] font-black opacity-30 flex items-center gap-1">
                                                        <Icon name="calendar" className="w-2.5 h-2.5" />{item.date}
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-[13px] opacity-70 line-clamp-2">{item.text}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'Setting' && (
                            <div className="fade-in space-y-4 pt-3">
                                <div className="bg-white p-6 rounded-2xl border border-black/5 space-y-6">
                                    <div>
                                        <h3 className="text-[11px] font-black opacity-30 uppercase tracking-widest mb-4">Storage</h3>
                                        <div className="space-y-3">
                                            <button onClick={handleExport} className="w-full flex items-center justify-between px-5 py-4 bg-[#F1F0EB] text-[#1A1A1A] rounded-xl btn-press">
                                                <div className="text-left"><div className="text-[11px] font-black uppercase">Export</div><div className="text-[9px] opacity-40 font-bold">백업 파일 만들기</div></div>
                                                <Icon name="download" className="w-5 h-5 opacity-40" />
                                            </button>
                                            <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-between px-5 py-4 border-2 border-[#1A1A1A] rounded-xl btn-press">
                                                <div className="text-left"><div className="text-[11px] font-black uppercase">Import</div><div className="text-[9px] opacity-40 font-bold">백업 불러오기</div></div>
                                                <Icon name="upload" className="w-5 h-5 opacity-40" />
                                            </button>
                                            <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden" />
                                        </div>
                                    </div>
                                    <div className="text-center py-6 border-t border-slate-50 opacity-40">
                                        <div className="cursive-title text-xl mb-1">{APP_NAME}</div>
                                        <p className="text-[9px] font-black uppercase tracking-widest">{APP_VERSION}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="px-4 flex justify-between items-center">
                        {[
                            { id: 'Journal', icon: 'book-open' }, 
                            { id: 'Todo', icon: 'check-square' }, 
                            { id: 'Memo', icon: 'feather' }, 
                            { id: 'Search', icon: 'search' },
                            { id: 'Setting', icon: 'settings' }
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center flex-1 transition-all ${activeTab === tab.id ? 'opacity-100' : 'opacity-20'}`}>
                                <Icon name={tab.icon} className="w-[18px] h-[18px]" />
                                <span className="text-[9px] font-black mt-1.5 tracking-tighter uppercase">{tab.id}</span>
                            </button>
                        ))}
                    </nav>

                    {showCalendar && (
                        <div className="absolute inset-0 z-[1100] bg-[#FDFCF8] flex flex-col p-8 fade-in" onClick={() => setShowCalendar(false)}>
                            <div className="flex justify-between items-end mb-12" onClick={e=>e.stopPropagation()}>
                                <div><span className="text-sm font-black opacity-30 block mb-1">{viewMonth.getFullYear()}</span><span className="calendar-month-title">{viewMonth.getMonth()+1}월</span></div>
                                <div className="flex gap-3 mb-2">
                                    <button onClick={()=>setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth()-1, 1))} className="p-3 bg-[#F1F0EB] rounded-2xl btn-press"><Icon name="chevron-left" className="w-6 h-6" /></button>
                                    <button onClick={()=>setViewMonth(new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 1))} className="p-3 bg-[#F1F0EB] rounded-2xl btn-press"><Icon name="chevron-right" className="w-6 h-6" /></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-7 gap-y-4 text-center overflow-y-auto no-scrollbar" onClick={e=>e.stopPropagation()}>
                                {['S','M','T','W','T','F','S'].map((d,i)=><span key={i} className={`text-[11px] font-black opacity-20 ${i===0?'text-sun':i===6?'text-sat':''}`}>{d}</span>)}
                                {Array.from({length: new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1).getDay()}).map((_,i)=><div key={i}/>)}
                                {Array.from({length: new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                    const d = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), i+1);
                                    let isSelected = false;
                                    if (calendarMode === 'select') isSelected = d.toDateString() === currentDate.toDateString();
                                    else isSelected = toLocalDateString(d) === (newTodo.date || toLocalDateString(new Date()));
                                    const hDay = getHolidayName(d);
                                    return (
                                        <button key={i} onClick={()=>{
                                            if (calendarMode === 'select') setCurrentDate(d);
                                            else setNewTodo({...newTodo, date: toLocalDateString(d)});
                                            setShowCalendar(false);
                                        }} className={`relative flex flex-col items-center py-4 transition-all ${isSelected ? 'bg-[#1A1A1A] text-white rounded-2xl shadow-xl' : ''}`}>
                                            <span className={`text-[17px] font-black ${!isSelected && (d.getDay()===0||hDay) ? 'text-sun' : !isSelected && d.getDay()===6 ? 'text-sat' : ''}`}>{i+1}</span>
                                            {(journals[d.toDateString()] || todos.some(t => t.date === toLocalDateString(d))) && !isSelected && <div className="calendar-dot" />}
                                            {hDay && <div className="text-[7px] font-black absolute bottom-1 truncate w-full px-1 text-center" style={{color: isSelected ? 'white' : 'var(--weekend-sun)'}}>{hDay}</div>}
                                        </button>
                                    )
                                })}
                            </div>
                            <button onClick={() => setShowCalendar(false)} className="mt-auto py-5 text-[11px] font-black uppercase tracking-widest opacity-20">Close</button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

